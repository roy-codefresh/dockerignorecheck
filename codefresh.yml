version: '1.0'
steps:
  test_before:
    title: Some tests before build
    image: alpine
    commands:
      - echo Hello World
      - apk add --update git
      - git status
  build:
    title: Building Docker Image
    type: build
    image_name: roycodefresh/dockerignorecheck
    tag: latest
    working_directory: ./
    dockerfile: Dockerfile
    no_cache: true
  comp:
    title: 'compositions'
    type: composition
    composition:
      version: '2'
      services:
        redis:
          image: redis
    composition_candidates:
      test:
        image: ${{build}}
        command: ping redis -c 4
    on_success:
      metadata:
        set:
          - '${{build.imageId}}':
              - CF_QUALITY: true
    on_fail:
      metadata:
        set:
          - '${{build.imageId}}':
              - CF_QUALITY: false
  push:
    title: 'push'
    type: push
    candidate: ${{build}}
    tag: ${{CF_BRANCH_TAG_NORMALIZED}}
